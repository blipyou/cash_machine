<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¶æ²³æˆ˜èˆ° Â· åŸºé‡‘ç»ç†é…ç½®å° V6.1</title>
    <style>
        :root { --primary: #108ee9; --accent: #ff5722; --bg: #f0f2f5; --card-bg: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #333; margin: 0; padding: 20px; display:flex; justify-content:center; }
        .container { width: 100%; max-width: 600px; background: var(--card-bg); border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); padding: 24px; }
        
        h1 { text-align: center; color: var(--primary); margin: 0 0 20px 0; font-size: 22px; border-bottom: 2px solid #e8e8e8; padding-bottom: 15px; }
        
        .grid-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; }
        
        label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 15px; box-sizing: border-box; background: #fafafa; transition:0.3s; }
        input:focus, select:focus { border-color: var(--primary); background: #fff; outline: none; }
        
        .section-header { font-size: 14px; font-weight: bold; color: #108ee9; margin: 25px 0 10px 0; display:flex; align-items:center; }
        .section-header::before { content:''; display:inline-block; width:4px; height:14px; background:#108ee9; margin-right:8px; border-radius:2px; }

        .btn { width: 100%; padding: 14px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 10px rgba(16, 142, 233, 0.3); }
        .btn:hover { background: #0e77ca; }

        .result-area { display: none; margin-top: 25px; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        .card { background: #fff; border: 1px solid #e8e8e8; border-radius: 10px; padding: 16px; margin-bottom: 16px; position: relative; overflow: hidden; }
        .card::after { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .card-blue::after { background: var(--primary); }
        .card-red::after { background: var(--accent); }

        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; }
        .data-val { font-weight: 700; color: #333; }
        .big-num { font-size: 18px; color: var(--accent); }
        .profit-num { font-size: 20px; color: #27a646; }
        
        .auto-tag { font-size: 12px; color: #27a646; background: #e6f7ff; padding: 2px 5px; border-radius: 4px; margin-left: 5px; display:none; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§­ åŸºé‡‘ç»ç†é…ç½®å° V6.1</h1>

    <!-- èµ„é‡‘ä¸æ ‡çš„ -->
    <div class="section-header">ç¬¬ä¸€æ­¥ï¼šåŸºç¡€æ•°æ®è¾“å…¥</div>
    <div class="grid-row">
        <div class="col">
            <label>æŠ•å…¥æ€»èµ„é‡‘ (å…ƒ)</label>
            <input type="number" id="capital" step="1000" placeholder="å¦‚ 50000" onchange="calculate()">
        </div>
        <div class="col">
            <label>å½“å‰ä»·æ ¼ (å…ƒ)</label>
            <input type="number" id="price" step="0.001" placeholder="å¦‚ 1.000" onchange="calculate(true)">
        </div>
    </div>

    <!-- ä¼°å€¼ä¸æ³¢åŠ¨ -->
    <div class="grid-row">
        <div class="col">
            <label>ä¼°å€¼ç™¾åˆ†ä½ (%) <span style="font-weight:normal;color:#999;font-size:11px">å†³å®šåº•ä»“</span></label>
            <input type="number" id="percentile" placeholder="0-100" value="50" onchange="calculate()">
        </div>
        <div class="col">
            <label>è¿‘ä¸€å¹´æ³¢åŠ¨ (ä½ç‚¹/é«˜ç‚¹)</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="lowYear" step="0.1" placeholder="æœ€ä½" onchange="calculate(true)">
                <input type="number" id="highYear" step="0.1" placeholder="æœ€é«˜" onchange="calculate(true)">
            </div>
        </div>
    </div>

    <!-- æ ¸å¿ƒå†³ç­–å‚æ•° -->
    <div class="section-header">ç¬¬äºŒæ­¥ï¼šåŸºé‡‘ç»ç†å†³ç­–</div>
    <div class="grid-row">
        <div class="col">
            <label>äº¤æ˜“é£æ ¼åå¥½</label>
            <select id="style" onchange="calculate(true)">
                <option value="high_freq">âš¡ é«˜é¢‘åˆ·å• (æ­¥é•¿æå°)</option>
                <option value="balanced" selected>âš–ï¸ ç¨³å¥æ³¢æ®µ (æ­¥é•¿é€‚ä¸­)</option>
                <option value="trend">ğŸŒŠ å¤§æµªæ·˜æ²™ (æ­¥é•¿å¾ˆå¤§)</option>
            </select>
        </div>
        <div class="col">
            <label>
                èµ„é‡‘åˆ‡å‰²ä»½æ•° (æ ¼å­)
                <span id="grid-auto-tag" class="auto-tag">å·²è‡ªåŠ¨è®¡ç®—</span>
            </label>
            <input type="number" id="gridCount" placeholder="ç³»ç»Ÿå°†è‡ªåŠ¨è®¡ç®—" onchange="calculate(false)">
        </div>
    </div>

    <button class="btn" onclick="calculate(false)">ç”Ÿæˆç²¾å‡†ç­–ç•¥</button>

    <!-- ç»“æœè¾“å‡º -->
    <div class="result-area" id="result">
        
        <!-- ä»“ä½å¡ç‰‡ -->
        <div class="card card-blue">
            <div class="data-row" style="border-bottom:1px dashed #eee; padding-bottom:8px; margin-bottom:10px;">
                <span style="color:#108ee9; font-weight:bold;">ğŸŸ¢ æ™ºèƒ½å»ºä»“æ–¹æ¡ˆ</span>
                <span id="pos-desc" style="font-size:12px; color:#999">--</span>
            </div>
            <div class="data-row">
                <span>æ‰‹åŠ¨ä¹°å…¥åº•ä»“</span>
                <span class="data-val big-num" style="color:#333" id="res-base-shares">--</span>
            </div>
            <div class="data-row">
                <span>æ¶ˆè€—èµ„é‡‘</span>
                <span class="data-val" id="res-base-cost">--</span>
            </div>
            <div class="data-row">
                <span>ä¿ç•™é˜²å¾¡ç°é‡‘</span>
                <span class="data-val" style="color:#27a646" id="res-cash">--</span>
            </div>
        </div>

        <!-- ç½‘æ ¼å‚æ•°å¡ç‰‡ -->
        <div class="card card-red">
            <div class="data-row" style="border-bottom:1px dashed #eee; padding-bottom:8px; margin-bottom:10px;">
                <span style="color:#ff5722; font-weight:bold;">ğŸ”´ é“¶æ²³æ¡ä»¶å•å¡«ç©º</span>
                <span style="font-size:12px; color:#999">V6.1 åŠ¨æ€è¦†ç›–ç®—æ³•</span>
            </div>
            
            <div class="grid-row" style="margin-bottom:0">
                <div class="col">
                    <span style="font-size:12px; color:#666; display:block">åŒºé—´ä¸‹é™</span>
                    <span class="data-val" id="res-low">--</span>
                </div>
                <div class="col" style="text-align:center">
                    <span style="font-size:12px; color:#666; display:block">ç½‘æ ¼æ­¥é•¿</span>
                    <span class="data-val big-num" id="res-step">--</span>
                </div>
                <div class="col" style="text-align:right">
                    <span style="font-size:12px; color:#666; display:block">åŒºé—´ä¸Šé™</span>
                    <span class="data-val" id="res-high">--</span>
                </div>
            </div>

            <div style="background:#fff7e6; padding:12px; border-radius:6px; margin-top:10px; border:1px solid #ffe7ba;">
                <div class="data-row">
                    <span>æ¯ç¬”å§”æ‰˜æ•°é‡</span>
                    <span class="data-val" style="color:#d48806; font-size:18px" id="res-qty">--</span>
                </div>
                <div class="data-row" style="margin-bottom:0">
                    <span>å•ç½‘æ ¼é¢„æœŸå‡€åˆ©</span>
                    <span class="data-val profit-num" id="res-profit">--</span>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    function calculate(recalcGrid = false) {
        // 1. è·å–è¾“å…¥
        const capital = parseFloat(document.getElementById('capital').value);
        const price = parseFloat(document.getElementById('price').value);
        const percentile = parseFloat(document.getElementById('percentile').value);
        const lowYear = parseFloat(document.getElementById('lowYear').value);
        const highYear = parseFloat(document.getElementById('highYear').value);
        const style = document.getElementById('style').value;
        
        let gridCountInput = document.getElementById('gridCount');
        let gridCount = parseInt(gridCountInput.value);

        if (!capital || !price || !lowYear || !highYear) return;

        // ----------------------------------------------------
        // æ ¸å¿ƒä¼˜åŒ–ï¼šè‡ªåŠ¨è®¡ç®—é»˜è®¤æ ¼å­æ•° (Safety Coverage Logic)
        // ----------------------------------------------------
        // åªæœ‰å½“å‚æ•°å˜åŠ¨(recalcGrid=true) æˆ–è€… æ ¼å­æ•°ä¸ºç©ºæ—¶ï¼Œæ‰è§¦å‘è‡ªåŠ¨è®¡ç®—
        if (recalcGrid || !gridCount) {
            
            // ç®—æ³•ï¼šè®¡ç®—æ­¥é•¿
            const volatility = (highYear - lowYear) / lowYear;
            let tempStep = 1.0;
            if (volatility < 0.2) tempStep = 0.5;
            else if (volatility < 0.4) tempStep = 0.8;
            else tempStep = 1.5;
            
            // é£æ ¼ä¿®æ­£æ­¥é•¿
            if (style === 'high_freq') tempStep = Math.max(0.3, tempStep * 0.6);
            if (style === 'trend') tempStep = tempStep * 1.5;

            // ç®—æ³•ï¼šæ ¼å­æ•° = (ç°ä»· - å®‰å…¨åº•) / (ç°ä»· * æ­¥é•¿)
            // å®‰å…¨åº•è®¾å®šä¸ºï¼šè¿‘ä¸€å¹´æœ€ä½ä»·çš„ 95% (é˜²å‡»ç©¿)
            const safeBottom = lowYear * 0.95;
            const distance = price - safeBottom;

            if (distance <= 0) {
                // å¦‚æœç°ä»·å·²ç»è·Œç©¿äº†å¹´çº¿ä½ç‚¹ -> æåº¦å®‰å…¨ï¼Œæ ¼å­å°‘ä¸€ç‚¹ï¼Œèµ„é‡‘é›†ä¸­
                gridCount = 15; 
            } else {
                // è®¡ç®—éœ€è¦å¤šå°‘æ ¼æ‰èƒ½è¦†ç›–åˆ°å®‰å…¨åº•
                let requiredGrids = Math.ceil(distance / (price * (tempStep/100)));
                // åŠ ä¸Š 20% çš„å®‰å…¨å†—ä½™
                gridCount = Math.ceil(requiredGrids * 1.2);
            }

            // è¾¹ç•Œé™åˆ¶ï¼šå¤ªå°‘ä¸è¡Œ(è‡³å°‘12æ ¼)ï¼Œå¤ªå¤šä¸è¡Œ(é“¶æ²³ä¸€èˆ¬é™åˆ¶50-100ï¼Œèµ„é‡‘å¤ªæ•£æ²¡æ„ä¹‰)
            gridCount = Math.max(12, Math.min(60, gridCount));

            // æ›´æ–°UI
            gridCountInput.value = gridCount;
            document.getElementById('grid-auto-tag').style.display = 'inline-block';
            document.getElementById('grid-auto-tag').innerText = `å·²æŒ‰å®‰å…¨åº• ${safeBottom.toFixed(3)} è‡ªåŠ¨ä¼˜åŒ–`;
        }
        // ----------------------------------------------------

        // 2. é‡æ–°è·å–æœ€æ–°çš„æ ¼å­æ•° (å…è®¸ç”¨æˆ·æ‰‹åŠ¨æ”¹)
        gridCount = parseInt(gridCountInput.value);

        // 3. æ™ºèƒ½è®¡ç®—æ­¥é•¿ (åŒä¸Šé€»è¾‘ï¼Œå†ç®—ä¸€éç¡®è®¤ä¸ºå‡†)
        const volatility = (highYear - lowYear) / lowYear;
        let step = 1.0;
        if (volatility < 0.2) step = 0.5;
        else if (volatility < 0.4) step = 0.8;
        else step = 1.5;
        if (style === 'high_freq') step = Math.max(0.3, step * 0.6);
        if (style === 'trend') step = step * 1.5;

        // 4. æ™ºèƒ½è®¡ç®—åº•ä»“æ¯”ä¾‹ (æ ¹æ®ä¼°å€¼)
        let baseRatio = 0.3;
        let posDesc = "ä¼°å€¼é€‚ä¸­";
        if (percentile < 20) { baseRatio = 0.45; posDesc = "ğŸ’ æåº¦ä½ä¼°ï¼Œé‡ä»“æ½œä¼"; }
        else if (percentile > 60) { baseRatio = 0.15; posDesc = "âš ï¸ ä¼°å€¼åé«˜ï¼Œè½»ä»“é˜²å¾¡"; }
        else if (percentile > 80) { baseRatio = 0; posDesc = "ğŸ”¥ æåº¦é«˜ä¼°ï¼Œå»ºè®®ç©ºä»“"; }

        // 5. æ™ºèƒ½åŒºé—´é”šå®š
        // ä¸‹é™å¿…é¡»è¦†ç›–åˆ°ï¼š(ç°ä»· - æ ¼å­æ•° * æ­¥é•¿) 
        // è¿™æ ·ä¿è¯ç½‘æ ¼è·‘æ»¡æ ¼å­æ•°æ—¶ï¼Œåˆšå¥½åˆ°åº•
        let calculatedLow = price * (1 - (gridCount * step / 100));
        // ä½†ä¹Ÿä¸èƒ½å¤ªç¦»è°±ï¼Œå’Œå†å²ä½ç‚¹å–ä¸ªå¹³è¡¡
        let gridLow = Math.min(calculatedLow, lowYear).toFixed(3);
        
        // ä¸Šé™ï¼šæ ¹æ®æ­¥é•¿å¾€ä¸Šæ¨
        let gridHigh = (price * (1 + (gridCount * step / 100))).toFixed(3);
        // å¦‚æœä¸Šæ–¹ç©ºé—´å¤ªå¤§ï¼Œé™åˆ¶åœ¨å¹´é«˜ç‚¹é™„è¿‘ï¼Œé¿å…æ— æ•ˆæŒ‚å•
        gridHigh = Math.max(gridHigh, highYear).toFixed(3); // å¯é€‰é€»è¾‘

        // 6. èµ„é‡‘è®¡ç®—
        const baseShares = Math.floor((capital * baseRatio) / price / 100) * 100;
        const baseCost = baseShares * price;
        const keepCash = capital - baseCost;

        // å•ç¬”å§”æ‰˜
        let perGridShares = Math.floor((keepCash / gridCount) / price / 100) * 100;
        if (perGridShares < 100) perGridShares = 100;
        
        const perGridAmount = perGridShares * price;

        // 7. å‡€åˆ©è®¡ç®—
        const buyFee = Math.max(0.1, perGridAmount * 0.00005);
        const sellAmount = perGridAmount * (1 + step/100);
        const sellFee = Math.max(0.1, sellAmount * 0.00005);
        const grossProfit = perGridAmount * (step/100);
        const netProfit = grossProfit - buyFee - sellFee;

        // 8. æ¸²æŸ“
        document.getElementById('result').style.display = 'block';
        document.getElementById('pos-desc').innerText = posDesc;
        document.getElementById('res-base-shares').innerText = baseShares + " è‚¡";
        document.getElementById('res-base-cost').innerText = "çº¦ " + baseCost.toFixed(0) + " å…ƒ";
        document.getElementById('res-cash').innerText = keepCash.toFixed(0) + " å…ƒ";

        document.getElementById('res-low').innerText = gridLow;
        document.getElementById('res-high').innerText = gridHigh;
        document.getElementById('res-step').innerText = step.toFixed(2) + "%";
        
        document.getElementById('res-qty').innerText = perGridShares + " è‚¡";
        document.getElementById('res-profit').innerText = netProfit.toFixed(2) + " å…ƒ";
    }
</script>

</body>
</html>